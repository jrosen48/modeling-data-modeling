---
title: "LCA data modeling Seth-Josh"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, message = FALSE, warning = FALSE, echo = FALSE)
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60),  # For code
                      width = 60)  # For output

options(cli.width = 60)  # For tidyverse loading messages
```

# 1. Loading, setting up

```{r}
library(dplyr)
library(purrr)
library(tidyr)
library(poLCA)

f <- "obs-segment_units1-7_2013-2014.csv"

d <- read_csv(f)

recode_vals <- function(x) {
    if_else
}

```

# 2. Preparing data with a few teacher and student variables

None of the unit-specific variables included.

```{r}
add_one <- function(x) {
    x + 1
}

ds <- d %>% 
    dplyr::select(sInvented, sProcedural, sConceptual, tInitSelect, tCompare, tDiscussQ, tConnectBigIdeas, tConnectOthers, tPressExplain) %>% 
    map_df(replace_na, 0) %>% 
    map_df(add_one)
```

# 3. Choosing the number of classes/profiles

Using latent class analysis through the **poLCA** R package.

```{r}
f <- cbind(sInvented, sProcedural, sConceptual, tInitSelect, tCompare, tDiscussQ, tConnectBigIdeas, tConnectOthers, tPressExplain) ~ 1


od <- map(1:9, poLCA, formula = f, data = ds, maxiter = 5000, verbose = FALSE, graphs = FALSE) %>% 
    map_df(broom::glance)

od %>% 
    mutate(n_classes = 1:9) %>% 
    ggplot(aes(x = n_classes, y = BIC)) +
    geom_point() +
    geom_line() +
    scale_x_continuous(breaks = 1:9, labels = 1:9) +
    theme_bw()

```

Based on this fit statistic--the Bayesian Information Criteria, which is just a transformation of the log-likelihood, and is usually recommended along with the AIC as one criterion for model selection--it looks like 3 and especially 4 or 5 class solutions seem reasonable.

# 4. Examining 3, 4, and 5 class solutions

```{r}

f <- cbind(sInvented, sProcedural, sConceptual, tInitSelect, tCompare, tDiscussQ, tConnectBigIdeas, tConnectOthers, tPressExplain) ~ 1

m3 <- poLCA(f, ds, nclass = 3, maxiter = 5000, graphs = TRUE)
m4 <- poLCA(f, ds, nclass = 4, maxiter = 5000, graphs = TRUE)
m5 <- poLCA(f, ds, nclass = 5, maxiter = 5000, graphs = TRUE)

plot(m3)
plot(m4)
plot(m5)

ds$m3_class <- m3$predclass
ds$m4_class <- m4$predclass
ds$m5_class <- m5$predclass

ds$segment <- d$SegNum
ds$teacher <- as.factor(d$`Teacher::TeacherID`)

ds %>% 
    mutate(yval = 1) %>% 
    ggplot(aes(x = segment,y =yval, color = as.factor(m3_class))) + geom_point() + geom_line() + facet_wrap(~teacher) +
    scale_y_continuous(labels = 1:3, breaks = 1:3)
    ggtitle("3 class/profile solution")
    
ds %>% 
    mutate(yval = 1) %>% 
    ggplot(aes(x = segment,y =yval, color = as.factor(m4_class))) + geom_point() + geom_line() + facet_wrap(~teacher) +
    scale_y_continuous(labels = 1:3, breaks = 1:3)
    ggtitle("4 class/profile solution")

ds %>% 
    mutate(yval = 1) %>% 
    ggplot(aes(x = segment,y =yval, color = as.factor(m5_class))) + geom_point() + geom_line() + facet_wrap(~teacher) +
    scale_y_continuous(labels = 1:3, breaks = 1:3)
    ggtitle("5 class/profile solution")


```