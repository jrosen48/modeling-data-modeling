---
title: "LCA data modeling Seth-Josh"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = FALSE, message = FALSE, warning = FALSE, echo = TRUE)
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60),  # For code
                      width = 60)  # For output

options(cli.width = 60)  # For tidyverse loading messages
set.seed(20180925)
```

# 1. Loading, setting up

```{r, load}
library(tidyverse)
library(poLCA)

f <- "obs-segment_units1-7_2013-2014.csv"
d <- read_csv(f)

f1 <- "Observations_segment_Units_1-7_2012-13.csv"
d1 <-read_csv(f1)
```

# 2. Preparing data with a few teacher and student variables

None of the unit-specific variables included.


```{r}

add_one <- function(x) {
    x + 1
}

ds <- d %>% 
    dplyr::select(sInvented, sProcedural, sConceptual, tInitSelect, tCompare, tDiscussQ, tConnectBigIdeas, tConnectOthers, tPressExplain, fGroups) %>% 
    map_df(replace_na, 0) %>% 
    map_df(add_one)

ds1 <- d1 %>% 
    dplyr::select(sInvented, sProcedural, sConceptual, tInitSelect, tCompare, tDiscussQ, tConnectBigIdeas, tConnectOthers, tPressExplain, fGroups) %>% 
    map_df(replace_na, 0) %>% 
    map_df(add_one)

dd <- bind_rows(ds, ds1)
```

# 3. Choosing the number of classes/profiles

Using latent class analysis through the **poLCA** R package.

```{r, mapping-fit-stats, results = 'hide', cache = TRUE}
f <- cbind(sInvented, sProcedural, sConceptual, tInitSelect, tCompare, tDiscussQ, tConnectBigIdeas, tConnectOthers, tPressExplain) ~ 1

od <- map(1:9, poLCA, formula = f, data = dd, maxiter = 5000, verbose = FALSE, graphs = FALSE) %>% 
    map_df(broom::glance)
```

```{r, plot}
od %>% 
    mutate(n_classes = 1:9) %>% 
    gather(key, val, BIC, AIC) %>% 
    ggplot(aes(x = n_classes, y = val, color = key, group = key)) +
    geom_point() +
    geom_line() +
    scale_x_continuous(breaks = 1:9, labels = 1:9) +
    theme_bw() +
    labs(caption = "Lower values of the AIC & BIC suggest preferred model(s); generally, BIC is more conservative than AIC")
```

Based on this fit statistic--the Bayesian Information Criteria, which is just a transformation of the log-likelihood, and is usually recommended along with the AIC as one criterion for model selection--it looks like 3 and especially 4 or 5 class solutions seem reasonable.

# 4. Examining 2, 3, 4, and 5 class solutions

```{r, spec-sols}
f <- cbind(sInvented, sProcedural, sConceptual, tInitSelect, tCompare, tDiscussQ, tConnectBigIdeas, tConnectOthers, tPressExplain) ~ 1

m2 <- poLCA(f, ds, nclass = 2, maxiter = 5000, graphs = TRUE)
m3 <- poLCA(f, ds, nclass = 3, maxiter = 5000, graphs = TRUE)
m4 <- poLCA(f, ds, nclass = 4, maxiter = 5000, graphs = TRUE)
m5 <- poLCA(f, ds, nclass = 5, maxiter = 5000, graphs = TRUE)
```